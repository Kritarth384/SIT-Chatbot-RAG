(()=>{let e=null,t=!1,n="",o="ready",s="voice";function i(e,t=null,n=null){const i=document.getElementById("primaryActionButton"),a=document.getElementById("buttonText"),r=document.getElementById("buttonIcon"),c=document.getElementById("statusDot"),d=document.getElementById("statusText");switch(o=e,i.classList.remove("recording","processing"),c.classList.remove("connected","recording","processing"),n&&(r.innerHTML=n),e){case"ready":a.textContent=t||("voice"===s?"Start Conversation":"Connect"),d.textContent="Ready to help",i.disabled=!1,r.innerHTML='<circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/>';break;case"connected":a.textContent=t||("voice"===s?"Start Speaking":"Connected"),d.textContent="Connected - Ready to listen",c.classList.add("connected"),i.disabled=!1,"voice"===s&&(r.innerHTML='<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>');break;case"recording":a.textContent="Stop Speaking",d.textContent="Listening...",i.classList.add("recording"),c.classList.add("recording"),i.disabled=!1,r.innerHTML='<rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect>';break;case"processing":a.textContent="Processing...",d.textContent="Processing your message",i.classList.add("processing"),c.classList.add("processing"),i.disabled=!0,r.innerHTML='<line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>'}}function a(e){s=e;const t=document.getElementById("voiceModeBtn"),n=document.getElementById("textModeBtn"),a=document.getElementById("textInputContainer"),r=document.getElementById("primaryActionButton");"voice"===e?(t.classList.add("active"),n.classList.remove("active"),a.classList.add("hidden"),r.classList.remove("hidden"),i(o)):(n.classList.add("active"),t.classList.remove("active"),a.classList.remove("hidden"),r.classList.add("hidden"),console.log("[Frontend] Switched to text mode, hiding primary button"))}let r=null,c=null,d=!1,l=!1,g=!1;function u(){const e=document.getElementById("animatedAvatar");if(e){e.classList.remove("avatar-speaking");const t=document.getElementById("speakingIndicator");t&&t.classList.add("hidden")}console.log("[Frontend] Switching to idle state"),r&&(c.style.opacity="0",c.pause(),r.style.opacity="1",console.log("[Frontend] Otter video stopped, showing idle image"))}function p(e){const t=document.getElementById("connectionStatus");t.textContent=e?"Connected":"Disconnected",t.classList.toggle("connected",e)}function y(e,t){const n=document.getElementById("chatMessages"),o=document.createElement("div");o.classList.add("message"),"user"===t?o.classList.add("user-message"):o.classList.add("bot-message"),o.innerHTML=`\n       <div class="message-content">${e}</div>\n   `,n.appendChild(o),n.scrollTop=n.scrollHeight}function m(e){y(`‚ùå ${e}`,"bot")}async function v(){try{t=!0,console.log("[Frontend] Starting STT recording"),g&&c&&r&&(c.style.opacity="0",c.pause(),r.style.opacity="1");const o=await navigator.mediaDevices.getUserMedia({audio:!0});if(!window.MediaRecorder)throw new Error("MediaRecorder is not supported in this browser");const s=new MediaRecorder(o),a=[];return e={mediaRecorder:s,stream:o,stop:function(){"inactive"!==s.state&&s.stop(),o.getTracks().forEach(e=>e.stop())}},s.addEventListener("dataavailable",e=>{e.data.size>0&&a.push(e.data)}),s.addEventListener("stop",async()=>{try{const e=new Blob(a,{type:"audio/wav"}),t=new FormData;t.append("audio",e,"recording.wav"),console.log("[Frontend] Sending audio to backend for speech-to-text");const o=await fetch("/api/speech-to-text",{method:"POST",body:t});if(!o.ok)throw new Error(`Server returned ${o.status}: ${o.statusText}`);const s=await o.json();s&&s.text&&(console.log("[Frontend] Received transcription:",s.text),n=s.text,y(`üí≠ "${s.text}"`,"user"),await async function(e){if(e.trim()){i("processing"),y("üîÑ Processing your question... This may take up to 2 minutes.","bot");try{const t=new AbortController,n=setTimeout(()=>t.abort(),6e5),o=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4",messages:[{role:"user",content:e}],stream:!1}),signal:t.signal});if(clearTimeout(n),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const s=await o.json();let a;a=s.choices&&s.choices[0]&&s.choices[0].message?s.choices[0].message.content:s.response?s.response:"Sorry, I could not process your request.",y(a,"bot");try{await async function(e){try{console.log("[Frontend] Converting text to speech:",e.substring(0,50)+"...");const t=await fetch("/api/text-to-speech",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e,voice_id:"21m00Tcm4TlvDq8ikWAM"})});if(!t.ok)throw new Error(`TTS API returned status: ${t.status}`);const n=await t.blob(),o=URL.createObjectURL(n),s=new Audio(o);s.addEventListener("loadeddata",()=>{console.log("[Frontend] Audio loaded and ready")}),s.addEventListener("playing",()=>{console.log("[Frontend] Audio started playing - starting otter video"),function(){const e=document.getElementById("animatedAvatar");if(e){e.classList.add("avatar-speaking");const t=document.getElementById("speakingIndicator");t&&t.classList.remove("hidden")}!function(){if(console.log("[Frontend] Switching to TTS speaking mode"),r){if(!g||!c)return console.log("[Frontend] No video available, keeping image"),void(r.style.opacity="1");console.log("[Frontend] Starting otter speaking video"),r.style.opacity="0",c.style.opacity="1";try{c.currentTime=0;const e=c.play();e&&"function"==typeof e.catch&&e.catch(()=>{console.log("[Frontend] Video autoplay blocked, enabling mute and retry"),c.muted=!0,c.setAttribute("muted",""),c.play().catch(()=>{console.log("[Frontend] Video play still failed after mute")})})}catch(e){console.error("[Frontend] Error playing video:",e)}}}()}()}),s.addEventListener("pause",()=>{console.log("[Frontend] Audio paused - stopping otter video"),u()}),s.addEventListener("ended",()=>{console.log("[Frontend] Audio ended - stopping otter video"),u(),URL.revokeObjectURL(o)}),s.addEventListener("error",()=>{console.error("[Frontend] Audio error - stopping otter video"),u(),URL.revokeObjectURL(o)});try{console.log("[Frontend] Starting audio playback..."),await s.play()}catch(e){console.error("‚ùå Audio play failed:",e),u(),URL.revokeObjectURL(o)}}catch(e){console.error("[Frontend] Error with text-to-speech:",e)}}(a)}catch(e){console.error("[Frontend] TTS failed but continuing:",e),u()}i("connected")}catch(e){console.error("[Frontend] Error sending voice message:",e),"AbortError"===e.name?m("Request timed out. The system is taking longer than expected to respond."):m("Failed to process your voice message."),u(),i("connected")}}}(s.text))}catch(e){console.error("[Frontend] Error getting transcription:",e),m("Failed to transcribe speech: "+e.message),i("connected")}}),s.start(),e}catch(e){return console.error("[Frontend] Error starting speech to text:",e),m("Failed to start speech recognition: "+e.message),t=!1,i("connected"),null}}async function h(e){if(e.trim()){y(e,"user"),i("processing"),y("üîÑ Processing your question... This may take up to 2 minutes.","bot");try{const t=new AbortController,n=setTimeout(()=>t.abort(),6e5),o=await fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-4",messages:[{role:"user",content:e}],stream:!1}),signal:t.signal});if(clearTimeout(n),!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const s=await o.json();let a;a=s.choices&&s.choices[0]&&s.choices[0].message?s.choices[0].message.content:s.response?s.response:"Sorry, I could not process your request.",y(a,"bot"),u(),i("connected")}catch(e){console.error("[Frontend] Error sending text message:",e),"AbortError"===e.name?m("Request timed out. The system is taking longer than expected to respond."):m("Failed to send your message."),u(),i("connected")}}}async function E(){switch(o){case"ready":await async function(){try{if(i("processing","Connecting..."),!await async function(){try{return await navigator.mediaDevices.getUserMedia({audio:!0}),!0}catch(e){return console.error("Microphone permission denied:",e),!1}}())return m("Microphone permission is required for voice features."),void i("ready");console.log("üîó [CONNECTION] Ready for direct STT/TTS"),p(!0),i("connected")}catch(e){console.error("üö® [ERROR] Error starting conversation:",e),i("ready"),m("Failed to start conversation. Please try again.")}}();break;case"connected":"voice"===s&&(i("recording"),await v());break;case"recording":i("processing"),await async function(){if(t)try{if(e&&"function"==typeof e.stop)return e.stop(),console.log("[Frontend] MediaRecorder stopped"),t=!1,""}catch(e){console.error("[Frontend] Error stopping STT stream:",e),t=!1}return""}()}}document.addEventListener("DOMContentLoaded",async()=>{console.log("üöÄ [INIT] Application starting..."),p(!1),await async function(){document.getElementById("animatedAvatar"),await async function(){try{c=document.createElement("video"),r=document.createElement("img");const e=navigator.userAgent.toLowerCase(),t=/^((?!chrome|android).)*safari\//.test(e)||e.includes("safari")&&!e.includes("chrome"),n=e.includes("mac os x");c.autoplay=!1,c.loop=!0,c.muted=!0,c.setAttribute("muted",""),c.playsInline=!0,c.setAttribute("playsinline",""),c.preload="auto",c.setAttribute("webkit-playsinline",""),c.style.width="100%",c.style.height="100%",c.style.objectFit="cover",r.style.width="100%",r.style.height="100%",r.style.objectFit="cover";const o=["assets/images/otter.jpg","/static/assets/images/otter.jpg"],s=["assets/videos/otter.mp4","/static/assets/videos/otter.mp4","assets/videos/otter.webm","/static/assets/videos/otter.webm"];l=await new Promise(e=>{let t=0;const n=()=>{if(t>=o.length)return e(!1);const s=o[t++];r.src=s;const i=()=>{r.removeEventListener("error",a),e(!0)},a=()=>{r.removeEventListener("load",i),n()};r.addEventListener("load",i,{once:!0}),r.addEventListener("error",a,{once:!0})};n()});const i=c.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"')||c.canPlayType("video/mp4"),a=c.canPlayType('video/webm; codecs="vp9"')||c.canPlayType("video/webm");console.log("[Frontend][Video] Browser capabilities => H264:",i,"WebM:",a,"Safari:",t,"Mac:",n),g=await new Promise(e=>{let t=0;const n=[],o=()=>{if(t>=s.length)return console.warn("[Frontend][Video] All candidate video sources failed:",n),e(!1);const i=s[t++];if(n.push(i),i.endsWith(".webm")&&!a)return console.log("[Frontend][Video] Skipping WebM candidate not supported by browser:",i),o();console.log("[Frontend][Video] Trying video source:",i),c.src=i;const r=()=>{l(),console.log("[Frontend][Video] Loaded video source:",i),e(!0)},d=e=>{l(),console.warn("[Frontend][Video] Failed video source:",i,e?.message||""),o()},l=()=>{c.removeEventListener("canplaythrough",r),c.removeEventListener("loadeddata",r),c.removeEventListener("error",d)};c.addEventListener("canplaythrough",r,{once:!0}),c.addEventListener("loadeddata",r,{once:!0}),c.addEventListener("error",d,{once:!0});try{c.load()}catch(e){console.error("[Frontend][Video] Exception on load for",i,e),d(e)}};o()}),g||console.warn("[Frontend][Video] No video could be loaded. Avatar will fallback to static image. If on macOS Safari, ensure the MP4 is encoded with H.264 + AAC."),d=l}catch(e){console.log("üìù Media assets not available:",e.message),d=l}}(),function(){const e=document.getElementById("animatedAvatar"),t=document.createElement("div");t.className="video-avatar-container",t.style.cssText="\n    position: relative;\n    width: 100%;\n    height: 100%;\n    border-radius: 15px;\n    overflow: hidden;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n  ",r&&l&&(r.className="avatar-media user-speaking-image",r.style.cssText+="\n      position: absolute;\n      top: 0;\n      left: 0;\n      opacity: 1;\n      transition: opacity 0.3s ease;\n    ",t.appendChild(r)),c&&g&&(c.className="avatar-media speaking-video",c.style.cssText+="\n      position: absolute;\n      top: 0;\n      left: 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    ",t.appendChild(c)),e.innerHTML="",e.appendChild(t)}()}(),i("ready"),document.getElementById("primaryActionButton").addEventListener("click",E),document.getElementById("voiceModeBtn").addEventListener("click",()=>a("voice")),document.getElementById("textModeBtn").addEventListener("click",()=>a("text"));const e=document.getElementById("textInput");document.getElementById("sendTextButton").addEventListener("click",()=>{const t=e.value.trim();t&&(console.log("üìù [USER_INPUT] Text message:",t),h(t),e.value="")}),e.addEventListener("keypress",t=>{if("Enter"===t.key){const t=e.value.trim();t&&(console.log("üìù [USER_INPUT] Text message (Enter):",t),h(t),e.value="")}}),a("voice"),console.log("‚úÖ [INIT] Application initialized successfully")})})();